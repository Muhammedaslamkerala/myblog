{% extends 'base.html' %}
{% load static %}

{% block title %}{{ profile_user.get_full_name|default:profile_user.username }} - Profile{% endblock %}

{% block extra_css %}
<style>
/* ---------------------------------- */
/* Design System & Base */
/* ---------------------------------- */
:root {
    --primary: #667eea;
    --primary-dark: #764ba2;
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --neutral-100: #f9fafb;
    --neutral-200: #e5e7eb;
    --neutral-800: #1f2937;
    --text-light: #6b7280;
}

body {
    background: linear-gradient(135deg, #f9fafb 0%, white 100%);
  
}
/* ---------------------------------- */
/* MODERN PROFILE HEADER */
/* ---------------------------------- */
.profile-header {
    background: var(--gradient-primary);
    color: white; 
    padding: 7rem 0 5rem; 
    margin-top: -70px;
    position: relative; 
    overflow: hidden; 
    text-align: center;
}

.profile-header::before, .profile-header::after {
    content: ''; 
    position: absolute; 
    border-radius: 50%; 
    opacity: 0.1; 
    z-index: 1;
}

.profile-header::before { 
    width: 400px; 
    height: 400px; 
    background: linear-gradient(45deg, white, #4dc0c0); 
    bottom: -200px; 
    right: -150px; 
}

.profile-header::after { 
    width: 300px; 
    height: 300px; 
    background: linear-gradient(-45deg, white, var(--primary)); 
    top: -100px; 
    left: -150px; 
}

.profile-content { 
    position: relative; 
    z-index: 2; 
    padding-top: 70px; 
}

/* ---------------------------------- */
/* PROFILE PICTURE & INITIALS AVATAR */
/* ---------------------------------- */
.profile-avatar-container {
    width: 140px; 
    height: 140px;
    border-radius: 50%;
    border: 5px solid white;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
    margin: 0 auto 1.5rem;
    overflow: hidden;
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
}

.profile-avatar-image { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
}

.profile-avatar-initials {
    font-size: 3.5rem;
    font-weight: 600;
    color: white;
}

.profile-name { 
    font-size: 2.75rem; 
    font-weight: 900; 
    text-shadow: 0 2px 10px rgba(0,0,0,0.2); 
}

.profile-username { 
    font-size: 1.2rem; 
    opacity: 0.8; 
    margin-bottom: 1rem; 
}

.profile-bio { 
    max-width: 600px; 
    margin: 0 auto 2.5rem; 
    font-size: 1.05rem; 
    line-height: 1.6; 
}


/* ---------------------------------- */
/* OPTION 1: GLASSMORPHISM STATS */
/* ---------------------------------- */
.profile-stats { 
    display: inline-flex; /* content-width only */
    justify-content: center; 
    gap: 0; /* Gap handled by padding/borders */
    margin: 2.5rem auto; 
    
    /* Glass Effect */
    background: rgba(255, 255, 255, 0.1); 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    padding: 1.5rem 2rem;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
}

.stat-item { 
    text-align: center; 
    padding: 0 2.5rem;
    position: relative;
    color: white;
}

/* Vertical Divider Lines */
.stat-item:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 10%;
    height: 80%;
    width: 1px;
    background: rgba(255, 255, 255, 0.3);
}

.stat-number { 
    font-size: 2.2rem; 
    font-weight: 800; 
    display: block; 
    color: #ffffff; /* Pure white for contrast */
    line-height: 1.1;
    margin-bottom: 0.25rem;
}

.stat-label { 
    font-size: 0.75rem; 
    text-transform: uppercase; 
    letter-spacing: 1.5px; 
    font-weight: 600;
    color: rgba(255, 255, 255, 0.85); /* Slightly transparent white */
}

.btn-profile { 
    padding: 0.8rem 2rem; 
    border-radius: 12px; 
    font-weight: 700; 
    text-decoration: none; 
    transition: all 0.3s ease; 
    display: inline-flex; 
    align-items: center; 
    gap: 0.5rem; 
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); 
    border: none; 
}

.btn-profile:hover { 
    transform: translateY(-3px); 
    box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2); 
}

.btn-follow { 
    color: white; 
    background: var(--gradient-primary); 
    cursor: pointer;
}

.btn-edit { 
    color: var(--primary-dark); 
    background: white; 
}

/* ---------------------------------- */
/* CONTENT SECTION & CARDS */
/* ---------------------------------- */
.content-section { 
    padding: 3rem 0; 
}

.section-card { 
    background: white; 
    border-radius: 20px; 
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); 
    border: 1px solid var(--neutral-200); 
    margin-bottom: 2rem; 
    overflow: hidden; 
}

.card-header { 
    padding: 1.5rem; 
    border-bottom: 1px solid var(--neutral-200); 
}

.card-title { 
    font-size: 1.25rem; 
    font-weight: 700; 
    color: var(--neutral-800); 
    margin:0; 
    display:flex; 
    align-items:center; 
    gap:0.75rem; 
}

.card-title i { 
    color: var(--primary); 
}

.card-body { 
    padding: 1.5rem; 
}

.info-grid { 
    display: grid; 
    gap: 1rem; 
}

.info-item { 
    display: flex; 
    align-items: center; 
    gap: 1rem; 
    padding: 1rem; 
    background: var(--neutral-100); 
    border-radius: 12px; 
}

.info-icon { 
    width: 44px; 
    height: 44px; 
    border-radius: 12px; 
    background: var(--gradient-primary); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    color: white; 
    font-size: 1.2rem; 
    flex-shrink: 0; 
}

.info-content h6 { 
    margin: 0 0 0.25rem; 
    font-size: 0.8rem; 
    color: var(--text-light); 
    text-transform:uppercase; 
    letter-spacing:0.5px; 
}

.info-content p, .info-content a { 
    margin: 0; 
    color: var(--neutral-800); 
    font-weight: 500; 
    text-decoration:none; 
    word-break: break-all; 
}

.info-content a:hover { 
    color: var(--primary); 
}

.social-links { 
    display: flex; 
    gap: 1rem; 
}

.social-link { 
    width: 48px; 
    height: 48px; 
    border-radius: 12px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    border: 2px solid var(--neutral-200); 
    color: var(--text-light); 
    text-decoration: none; 
    transition: all 0.3s ease; 
    font-size: 1.25rem; 
}

.social-link:hover { 
    border-color: var(--primary); 
    color: var(--primary); 
    transform: translateY(-2px); 
}

/* ---------------------------------- */
/* POST CARD STYLES (FIXED) */
/* ---------------------------------- */
.post-card { 
    display: flex; 
    align-items: stretch;
    color: inherit; 
    background: white; 
    border-radius: 16px; 
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.07); 
    /* FIX: Visible to allow dropdown overflow */
    overflow: visible; 
    margin-bottom: 1rem; 
    transition: all .3s ease; 
    border: 1px solid var(--neutral-200); 
    position: relative;
    z-index: 1;
}

/* FIX: Ensure hovered card or active card stays on top */
.post-card:hover, .post-card.card-active { 
    transform: translateY(-5px); 
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); 
    z-index: 100 !important; /* Forces card to front so menu isn't hidden */
}

.post-card-link {
    display: flex;
    text-decoration: none;
    color: inherit;
    flex: 1;
    min-width: 0;
}

.post-thumbnail { 
    width: 120px; 
    height: 120px; 
    object-fit: cover; 
    flex-shrink: 0; 
    background: var(--neutral-100);
    /* FIX: Add radius here since parent overflow is visible */
    border-top-left-radius: 16px;
    border-bottom-left-radius: 16px;
}

.post-content { 
    padding: 1rem 1.25rem; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    flex: 1;
    min-width: 0;
}

.post-title { 
    font-size: 1.1rem; 
    font-weight: 600; 
    margin-bottom: 0.5rem; 
    color: var(--neutral-800);
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.post-meta { 
    display: flex; 
    gap: 1.5rem; 
    font-size: 0.8rem; 
    color: var(--text-light); 
    align-items: center;
    flex-wrap: wrap;
}

.post-meta span { 
    display: inline-flex; 
    align-items: center; 
    gap: 0.4rem; 
}

/* ---------------------------------- */
/* THREE DOTS MENU */
/* ---------------------------------- */
.post-actions-menu {
    position: relative;
    display: flex;
    align-items: center;
    padding: 0 1rem;
    z-index: 25;
}

.three-dots-btn {
    width: 40px; 
    height: 40px;
    border-radius: 10px;
    background: var(--neutral-100);
    border: 1px solid var(--neutral-200);
    color: var(--text-light);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    transition: all 0.2s ease;
}

.three-dots-btn:hover {
    background: var(--neutral-200);
    color: var(--neutral-800);
}

/* Dropdown menu */
.post-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    border: 1px solid var(--neutral-200);
    min-width: 200px;
    z-index: 1000; /* Very high z-index */
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.2s ease;
}

.post-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: var(--neutral-800);
    text-decoration: none;
    font-size: 0.95rem;
    transition: background 0.2s;
    cursor: pointer;
    position: relative; /* Ensures clicks register */
}

.dropdown-item:first-child {
    border-radius: 12px 12px 0 0;
}

.dropdown-item:last-child {
    border-radius: 0 0 12px 12px;
}

.dropdown-item:hover {
    background: var(--neutral-100);
}

.dropdown-item.danger {
    color: #ef4444;
}

.dropdown-item.danger:hover {
    background: #fef2f2;
}

.dropdown-divider {
    height: 1px;
    background: var(--neutral-200);
    margin: 0.5rem 0;
}

/* ---------------------------------- */
/* MODAL STYLES */
/* ---------------------------------- */
.modal-overlay { 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%; 
    background:rgba(23,25,35,0.6); 
    display:none; 
    align-items:center; 
    justify-content:center; 
    z-index:1050; 
    backdrop-filter:blur(5px); 
}

.modal-box { 
    background:white; 
    width:90%; 
    max-width:450px; 
    border-radius:20px; 
    box-shadow:0 10px 40px rgba(0,0,0,0.2); 
    max-height:80vh; 
    display:flex; 
    flex-direction:column; 
}

.modal-header { 
    padding:1rem 1.5rem; 
    border-bottom:1px solid var(--neutral-200); 
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
}

.modal-title { 
    font-size:1.2rem; 
    font-weight:700; 
}

.modal-close { 
    background:none; 
    border:none; 
    font-size:1.5rem; 
    cursor:pointer; 
    color: var(--text-light);
    transition: color 0.2s;
}

.modal-close:hover {
    color: var(--neutral-800);
}

.modal-body { 
    padding:0.5rem 1.5rem 1.5rem; 
    overflow-y:auto; 
}

.user-list-item { 
    display:flex; 
    align-items:center; 
    padding:0.75rem 0; 
    border-bottom: 1px solid var(--neutral-200);
}

.user-list-item:last-child {
    border-bottom: none;
}

.user-card-link { 
    display:flex; 
    align-items:center; 
    text-decoration:none; 
    flex-grow:1; 
    min-width:0; 
}

.modal-avatar-image, .modal-avatar-initials {
    width: 45px; 
    height: 45px;
    border-radius: 50%;
    margin-right: 1rem;
    flex-shrink: 0;
}

.modal-avatar-image { 
    object-fit: cover; 
}

.modal-avatar-initials {
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--gradient-primary);
    color: white;
    font-weight: 600;
    font-size: 1rem;
}

.user-info { 
    min-width: 0; 
}

.user-info .name { 
    font-weight:600; 
    color:var(--neutral-800); 
    white-space:nowrap; 
    overflow:hidden; 
    text-overflow:ellipsis; 
    display:block; 
}

.user-info .username { 
    color:var(--text-light); 
    font-size:0.9rem; 
    display:block; 
}

.modal-follow-btn { 
    padding:0.4rem 0.9rem; 
    font-size:0.85rem; 
    border-radius:8px; 
    border:1px solid var(--primary); 
    background:var(--primary); 
    color:white; 
    font-weight:600; 
    cursor:pointer; 
    transition:all .2s ease; 
    flex-shrink:0; 
    margin-left:1rem; 
}

.modal-follow-btn.following { 
    background:white; 
    color:var(--neutral-800); 
    border-color:var(--neutral-200); 
}

.modal-follow-btn.following:hover { 
    background:#fef2f2; 
    border-color:#fca5a5; 
    color:#b91c1c; 
}

.modal-follow-btn:hover {
    transform: scale(1.05);
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-light);
}

.empty-state i {
    font-size: 3rem;
    color: var(--neutral-200);
    margin-bottom: 1rem;
}

/* ---------------------------------- */
/* RESPONSIVE */
/* ---------------------------------- */
@media (max-width: 768px) {
    .profile-header {
        padding: 6rem 0 4rem;
    }
    
    .profile-name {
        font-size: 2rem;
    }
    
    .profile-stats {
        gap: 1.5rem;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .post-card {
        flex-direction: column;
        align-items: stretch;
    }

    .post-card-link {
        flex-direction: column;
    }
    
    .post-thumbnail {
        width: 100%;
        height: 180px;
        /* FIX: Update radius for stacked mobile view */
        border-radius: 16px 16px 0 0;
    }

    .post-actions-menu {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 25;
        padding: 0;
    }

    .three-dots-btn {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(4px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .post-dropdown {
        right: 0;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Profile Header -->
<section class="profile-header">
    <div class="profile-content">
        <div class="container">
            <!-- Profile Avatar -->
            <div class="profile-avatar-container">
                {% if profile_user.profile.profile_picture %}
                    <img src="{{ profile_user.profile.profile_picture.url }}" 
                         alt="{{ profile_user.username }}'s profile picture" 
                         class="profile-avatar-image">
                {% else %}
                    <div class="profile-avatar-initials">
                        {% if profile_user.first_name and profile_user.last_name %}
                            {{ profile_user.first_name.0|upper }}{{ profile_user.last_name.0|upper }}
                        {% else %}
                            {{ profile_user.username.0|upper }}
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Profile Info -->
            <h1 class="profile-name">{{ profile_user.get_full_name|default:profile_user.username }}</h1>
            <p class="profile-username">@{{ profile_user.username }}</p>
            
            {% if profile_user.profile.bio %}
                <p class="profile-bio">{{ profile_user.profile.bio }}</p>
            {% endif %}

            <!-- Stats with Inline Colors -->
            <div class="profile-stats">
                <div class="stat-item">
                    <span class="stat-number">{{ total_posts }}</span>
                    <span class="stat-label">Posts</span>
                </div>
                <div class="stat-item clickable" data-type="followers" data-user-id="{{ profile_user.id }}">
                    <span class="stat-number" id="followers-count">{{ followers_count }}</span>
                    <span class="stat-label">Followers</span>
                </div>
                <div class="stat-item clickable" data-type="following" data-user-id="{{ profile_user.id }}">
                    <span class="stat-number" id="following-count">{{ following_count }}</span>
                    <span class="stat-label">Following</span>
                </div>
            </div>
         

            <!-- Action Buttons -->
            <div class="profile-actions">
                {% if is_own_profile %}
                    <a href="{% url 'users:profile_edit' %}" class="btn-profile btn-edit">
                        <i class="bi bi-pencil-square"></i> Edit Profile
                    </a>
                {% else %}
                    <button class="btn-profile btn-follow" id="mainFollowBtn" data-user-id="{{ profile_user.id }}">
                        {% if is_following %}
                            <i class="bi bi-check-circle-fill"></i> Following
                        {% else %}
                            <i class="bi bi-plus-circle-fill"></i> Follow
                        {% endif %}
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Content Section -->
<section class="content-section">
    <div class="container">
        <div class="row">
            <!-- Left Sidebar - About & Social -->
            <div class="col-lg-4">
                <!-- About Card -->
                <div class="section-card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="bi bi-person-lines-fill"></i> About
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="bi bi-envelope-fill"></i>
                                </div>
                                <div class="info-content">
                                    <h6>Email</h6>
                                    <p>{{ profile_user.email }}</p>
                                </div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="bi bi-calendar-check-fill"></i>
                                </div>
                                <div class="info-content">
                                    <h6>Member Since</h6>
                                    <p>{{ profile_user.date_joined|date:"F Y" }}</p>
                                </div>
                            </div>
                            
                            {% if profile_user.profile.website %}
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="bi bi-globe"></i>
                                </div>
                                <div class="info-content">
                                    <h6>Website</h6>
                                    <a href="{{ profile_user.profile.website }}" target="_blank" rel="noopener">
                                        {{ profile_user.profile.website }}
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Social Links Card -->
                {% if profile_user.profile.twitter_url or profile_user.profile.linkedin_url or profile_user.profile.github_url %}
                <div class="section-card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="bi bi-share-fill"></i> Social Links
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="social-links">
                            {% if profile_user.profile.twitter_url %}
                            <a href="{{ profile_user.profile.twitter_url }}" 
                               target="_blank" 
                               rel="noopener"
                               class="social-link" 
                               title="Twitter">
                                <i class="bi bi-twitter"></i>
                            </a>
                            {% endif %}
                            
                            {% if profile_user.profile.linkedin_url %}
                            <a href="{{ profile_user.profile.linkedin_url }}" 
                               target="_blank" 
                               rel="noopener"
                               class="social-link" 
                               title="LinkedIn">
                                <i class="bi bi-linkedin"></i>
                            </a>
                            {% endif %}
                            
                            {% if profile_user.profile.github_url %}
                            <a href="{{ profile_user.profile.github_url }}" 
                               target="_blank" 
                               rel="noopener"
                               class="social-link" 
                               title="GitHub">
                                <i class="bi bi-github"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Content - Posts -->
            <div class="col-lg-8">
                <div class="section-card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="bi bi-file-earmark-text-fill"></i> Recent Posts
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if recent_posts %}
                            {% for post in recent_posts %}
                                <div class="post-card">
                                    <a href="{{ post.get_absolute_url }}" class="post-card-link">
                                        {% if post.featured_image %}
                                            <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" class="post-thumbnail">
                                        {% else %}
                                            <div class="post-thumbnail"></div>
                                        {% endif %}
                                        <div class="post-content">
                                            <h6 class="post-title">{{ post.title }}</h6>
                                            <div class="post-meta">
                                                <span><i class="bi bi-calendar3"></i> {{ post.published_date|date:"M d, Y" }}</span>
                                                <span><i class="bi bi-heart-fill"></i> {{ post.likes_count|default:0 }}</span>
                                                <span><i class="bi bi-chat-fill"></i> {{ post.comments.count|default:0 }}</span>
                                                <span><i class="bi bi-eye-fill"></i> {{ post.views_count|default:0 }}</span>
                                            </div>
                                        </div>
                                    </a>

                                    <!-- Three Dots Menu -->
                                    <div class="post-actions-menu">
                                        <button class="three-dots-btn" onclick="togglePostMenu(event, this)">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>

                                        <div class="post-dropdown">
                                            {% if request.user == post.author %}
                                                <a href="{% url 'blog:post_edit' post.slug %}" class="dropdown-item">
                                                    <i class="bi bi-pencil-square"></i> Edit Post
                                                </a>
                                                <a href="{% url 'blog:post_delete' post.slug %}" class="dropdown-item danger"
                                                   onclick="return confirm('Are you sure you want to delete this post?')">
                                                    <i class="bi bi-trash"></i> Delete Post
                                                </a>
                                                <div class="dropdown-divider"></div>
                                            {% endif %}

                                            <!-- Share options -->
                                            <!-- FIX: URL Construction -->
                                            <div class="dropdown-item" onclick="copyPostUrl('{{ request.scheme }}://{{ request.get_host }}{{ post.get_absolute_url }}', event)">
                                                <i class="bi bi-clipboard"></i> Copy Link
                                            </div>
                                            <a href="https://twitter.com/intent/tweet?url={{ request.scheme }}://{{ request.get_host }}{{ post.get_absolute_url }}&text={{ post.title|urlencode }}"
                                               target="_blank" class="dropdown-item">
                                                <i class="bi bi-twitter-x"></i> Share on Twitter
                                            </a>
                                            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.scheme }}://{{ request.get_host }}{{ post.get_absolute_url }}"
                                               target="_blank" class="dropdown-item">
                                                <i class="bi bi-facebook"></i> Share on Facebook
                                            </a>
                                            <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.scheme }}://{{ request.get_host }}{{ post.get_absolute_url }}&title={{ post.title|urlencode }}"
                                               target="_blank" class="dropdown-item">
                                                <i class="bi bi-linkedin"></i> Share on LinkedIn
                                            </a>
                                            <a href="https://api.whatsapp.com/send?text={{ post.title|urlencode }}%20{{ request.scheme }}://{{ request.get_host }}{{ post.get_absolute_url }}"
                                               target="_blank" class="dropdown-item">
                                                <i class="bi bi-whatsapp"></i> Share on WhatsApp
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class="bi bi-file-earmark-text"></i>
                                <p>No posts to show yet.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Followers/Following Modal -->
<div class="modal-overlay" id="followers-modal">
    <div class="modal-box">
        <div class="modal-header">
            <h5 class="modal-title" id="modal-title">Followers</h5>
            <button class="modal-close" id="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body" id="modal-user-list">
            <!-- User list will be dynamically loaded here -->
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CSRF Token helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const CSRF_TOKEN = getCookie('csrftoken');
    
    // Toggle follow function
    function handleToggleFollow(userId, callback) {
        fetch("/account/api/toggle-follow/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify({ user_id: userId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                callback(data);
            } else {
                alert(data.error || 'An error occurred.');
            }
        })
        .catch(error => {
            console.error('Toggle follow error:', error);
            alert('Failed to update follow status.');
        });
    }
    
    // Main follow button
    const mainFollowBtn = document.getElementById('mainFollowBtn');
    if (mainFollowBtn) {
        mainFollowBtn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            handleToggleFollow(userId, (data) => {
                const followersCountEl = document.getElementById('followers-count');
                let currentFollowers = parseInt(followersCountEl.textContent);
                
                if (data.following) {
                    this.innerHTML = '<i class="bi bi-check-circle-fill"></i> Following';
                    followersCountEl.textContent = currentFollowers + 1;
                } else {
                    this.innerHTML = '<i class="bi bi-plus-circle-fill"></i> Follow';
                    followersCountEl.textContent = currentFollowers - 1;
                }
            });
        });
    }
    
    // Modal elements
    const modalOverlay = document.getElementById('followers-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalTitle = document.getElementById('modal-title');
    const modalUserList = document.getElementById('modal-user-list');
    
    // Open modal on stat click
    document.querySelectorAll('.stat-item.clickable').forEach(item => {
        item.addEventListener('click', function() {
            const type = this.dataset.type;
            const userId = this.dataset.userId;
            
            modalTitle.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            modalUserList.innerHTML = '<div class="empty-state"><p>Loading...</p></div>';
            modalOverlay.style.display = 'flex';
            
            const apiUrl = `/account/api/users/${userId}/${type}/`;
            
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    modalUserList.innerHTML = '';
                    if (data.users && data.users.length > 0) {
                        data.users.forEach(user => {
                            let avatarHtml = user.avatar_url && user.avatar_url.trim() !== '' ?
                                `<img src="${user.avatar_url}" class="modal-avatar-image" alt="${user.username}">` :
                                `<div class="modal-avatar-initials">${user.initials}</div>`;
                            
                            const userHtml = `
                                <div class="user-list-item">
                                    <a href="/account/profile/${user.username}/" class="user-card-link">
                                        ${avatarHtml}
                                        <div class="user-info">
                                            <div class="name">${user.full_name}</div>
                                            <div class="username">@${user.username}</div>
                                        </div>
                                    </a>
                                    ${user.show_follow_button ?
                                        `<button class="modal-follow-btn ${user.is_following ? 'following' : ''}" data-user-id="${user.id}">
                                            ${user.is_following ? 'Following' : 'Follow'}
                                        </button>`
                                        : ''
                                    }
                                </div>
                            `;
                            modalUserList.insertAdjacentHTML('beforeend', userHtml);
                        });
                    } else {
                        modalUserList.innerHTML = `<div class="empty-state"><i class="bi bi-people"></i><p>No ${type} found.</p></div>`;
                    }
                })
                .catch(error => {
                    console.error('Error fetching user list:', error);
                    modalUserList.innerHTML = '<div class="empty-state"><p style="color: #ef4444;">Could not load list. Please try again.</p></div>';
                });
        });
    });
    
    // Handle follow button clicks inside modal
    modalUserList.addEventListener('click', function(event) {
        if (event.target.matches('.modal-follow-btn')) {
            const button = event.target;
            const userIdToToggle = button.dataset.userId;
            
            handleToggleFollow(userIdToToggle, (data) => {
                if (data.following) {
                    button.textContent = 'Following';
                    button.classList.add('following');
                } else {
                    button.textContent = 'Follow';
                    button.classList.remove('following');
                }
            });
        }
    });
    
    // Close modal handlers
    function closeModal() {
        modalOverlay.style.display = 'none';
    }
    
    modalCloseBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', (event) => {
        if (event.target === modalOverlay) closeModal();
    });
    document.addEventListener('keydown', (event) => {
        if (event.key === "Escape") closeModal();
    });
});

// Three dots menu toggle with Z-Index Fix
function togglePostMenu(event, button) {
    event.stopPropagation();
    event.preventDefault();
    
    const container = button.closest('.post-actions-menu');
    const dropdown = container.querySelector('.post-dropdown');
    const currentCard = button.closest('.post-card');
    
    // Close all other open menus and remove Z-index boost
    document.querySelectorAll('.post-dropdown.show').forEach(menu => {
        if (menu !== dropdown) {
            menu.classList.remove('show');
            const card = menu.closest('.post-card');
            if (card) card.classList.remove('card-active');
        }
    });
    
    // Toggle current menu
    if (dropdown) {
        const isOpening = !dropdown.classList.contains('show');
        dropdown.classList.toggle('show');
        
        // Toggle high z-index on the card itself
        if (currentCard) {
            if (isOpening) {
                currentCard.classList.add('card-active');
            } else {
                currentCard.classList.remove('card-active');
            }
        }
    }
}

// Close menus when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.post-actions-menu')) {
        document.querySelectorAll('.post-dropdown.show').forEach(menu => {
            menu.classList.remove('show');
            const card = menu.closest('.post-card');
            if (card) card.classList.remove('card-active');
        });
    }
});

// FIX: Capture element immediately to prevent "Cannot read properties of null"
function copyPostUrl(url, event) {
    event.stopPropagation();
    event.preventDefault();

    // Store the element NOW. event.currentTarget becomes null in async callbacks.
    const triggerElement = event.currentTarget; 
    
    // Check if clipboard API is supported (requires HTTPS or localhost)
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(() => {
            showCopySuccess(triggerElement); // Use the stored variable
        }).catch(err => {
            console.error('Clipboard API failed:', err);
            fallbackCopyTextToClipboard(url, triggerElement); // Use the stored variable
        });
    } else {
        fallbackCopyTextToClipboard(url, triggerElement); // Use the stored variable
    }
}

function showCopySuccess(item) {
    if (!item) return; // Safety check
    const original = item.innerHTML;
    item.innerHTML = '<i class="bi bi-check-circle-fill" style="color:#10b981;"></i> Copied!';
    setTimeout(() => {
        item.innerHTML = original;
    }, 2000);
}

// Fallback for older browsers or non-secure contexts
function fallbackCopyTextToClipboard(text, item) {
    var textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Avoid scrolling to bottom
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        var successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess(item);
        } else {
            // Silent fail or minimal alert if strictly needed
            console.warn('Copy command failed');
        }
    } catch (err) {
        console.error('Fallback copy failed', err);
    }
    
    document.body.removeChild(textArea);
}
</script>
{% endblock %}