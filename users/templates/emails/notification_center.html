{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Notification Center</h2>
    <div id="notification-list">
        {% for notification in page_obj %}
        <div class="card mb-3" id="notification-{{ notification.id }}">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title">{{ notification.subject }}</h5>
                    <p class="card-text text-muted mb-0">
                        Status: <strong class="status-text" data-notification-id="{{ notification.id }}">{{ notification.get_status_display }}</strong>
                    </p>
                    <small class="text-muted">Created: {{ notification.created_at|date:"F d, Y, P" }}</small>
                </div>
                <div class="resend-container" data-notification-id="{{ notification.id }}">
                    {% if notification.status == 'failed' %}
                    <button class="btn btn-sm btn-primary resend-btn" data-notification-id="{{ notification.id }}">Resend</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <p>You have no notifications.</p>
        {% endfor %}
    </div>
    
    <!-- Add a toast container for messages -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
      <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Notification Status</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          <!-- Message will be inserted here -->
        </div>
      </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// ========================================================================
// IMMEDIATE RUN-ONCE GUARD
// ========================================================================
if (typeof window.MyBlogNotificationSocket === 'undefined') {

    window.MyBlogNotificationSocket = true;

    // ========================================================================
    // FINAL DEBUG STEP: Listen for page unload events
    // If this log appears right after "connected", the page is reloading itself.
    // ========================================================================
    window.addEventListener('beforeunload', function (e) {
        console.error('CRITICAL: The page is unloading or reloading! This is why the WebSocket is closing.');
    });

    document.addEventListener('DOMContentLoaded', function() {
        // ... (the rest of your script remains exactly the same)
        const toastEl = document.getElementById('notificationToast');
        if (!toastEl) { console.error("Toast element #notificationToast not found!"); return; }
        const toast = new bootstrap.Toast(toastEl);

        console.log("Initializing WebSocket for notifications...");
        
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const notificationSocket = new WebSocket(
            `${protocol}//${window.location.host}/ws/notifications/`
        );

        notificationSocket.onopen = function(e) {
            console.log("SUCCESS: Notification WebSocket connected successfully.");
        };

        notificationSocket.onmessage = function(e) {
            console.log("--- MESSAGE RECEIVED ---");
            console.log("Raw data:", e.data);
            const data = JSON.parse(e.data);
            console.log("Parsed data object:", data);
            // ... (the rest of your onmessage logic)
        };

        notificationSocket.onclose = function(e) {
            console.error('ERROR: Notification socket closed.', e);
        };
        
        notificationSocket.onerror = function(e) {
            console.error('ERROR: A WebSocket error occurred.', e);
        };
        
        // ... (the rest of your functions: getCsrfToken, addResendListener)
    });
}
</script>
{% endblock %}