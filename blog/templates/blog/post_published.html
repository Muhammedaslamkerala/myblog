{% extends 'base.html' %}
{% load static %}

{% block title %}My Posts - MyBlog{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #667eea;
        --primary-dark: #764ba2;
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --text-heading: #1f2937;
        --text-body: #4b5563;
        --text-light: #6b7280;
        --neutral-100: #f9fafb;
        --neutral-200: #e5e7eb;
        --neutral-700: #374151;
    }
    body { 
        background: linear-gradient(135deg, #f9fafb 0%, white 100%);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* Dashboard Header */
    .dashboard-header {
        background: var(--gradient-primary);
        color: white;
        padding: 5rem 0 3rem;
        margin-top: -70px;
        position: relative;
        overflow: hidden;
    }
    .dashboard-header::before, .dashboard-header::after {
        content: '';
        position: absolute;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
    .dashboard-header::before { width: 500px; height: 500px; top: -250px; right: -100px; }
    .dashboard-header::after { width: 300px; height: 300px; bottom: -150px; left: -50px; }
    .dashboard-header .container {
        position: relative;
        z-index: 2;
        padding-top: 70px;
    }
    .breadcrumb { background: transparent; padding: 0; margin-bottom: 1rem; }
    .breadcrumb-item a { color: rgba(255, 255, 255, 0.9); text-decoration: none; transition: color 0.3s ease; }
    .breadcrumb-item a:hover { color: white; }
    .breadcrumb-item.active { color: rgba(255, 255, 255, 0.7); }
    .breadcrumb-item + .breadcrumb-item::before { color: rgba(255, 255, 255, 0.6); }
    .dashboard-title {
        font-size: 2.5rem;
        font-weight: 900;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    .dashboard-subtitle { font-size: 1.1rem; opacity: 0.9; margin-bottom: 0; }
    .btn-primary {
        background: white;
        color: var(--primary-dark);
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 12px;
        font-weight: 700;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        color: var(--primary-dark);
    }

    /* Tabs Navigation */
    .nav-tabs {
        border-bottom: 2px solid var(--neutral-200);
        margin-bottom: 2rem;
    }
    .nav-tabs .nav-link {
        border: none;
        padding: 1rem 1.5rem;
        font-weight: 600;
        color: var(--text-light);
        margin-bottom: -2px;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
    }
    .nav-tabs .nav-link.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
        background: transparent;
    }
    .nav-tabs .nav-link:hover {
        color: var(--primary);
    }
    .nav-tabs .badge {
        margin-left: 0.5rem;
        background-color: var(--neutral-200);
        color: var(--text-body);
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .nav-tabs .nav-link.active .badge {
        background-color: var(--primary);
        color: white;
    }

    /* Filter Bar */
    .dashboard-content { padding: 3rem 0; }
    .filter-search-bar { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 2rem; border: 1px solid var(--neutral-200); }
    .posts-count { font-size: 1rem; color: var(--text-body); font-weight: 600; padding: 0.75rem 1rem; background: #f9fafb; border-radius: 12px; border: 1px solid var(--neutral-200); display: inline-block; }
    .form-select, .form-control { padding: 0.75rem 1rem; border: 2px solid var(--neutral-200); border-radius: 12px; transition: all 0.3s ease; }
    .form-select:focus, .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); outline: none; }
    .search-box { position: relative; }
    .search-box i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9ca3af; }
    .search-box .form-control { padding-left: 2.75rem; }

    /* Posts Grid */
    .posts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    /* Universal Post Card */
    .post-card { background: white; border-radius: 16px; display: flex; flex-direction: column; height: 100%; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); border: 1px solid #e2e8f0; transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; position: relative; }
    .post-card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
    .post-card.status-published:hover { border-color: var(--primary); }
    .post-card.status-draft:hover { border-color: var(--warning); }
    .post-card.status-private:hover { border-color: var(--neutral-700); }

    /* Card Image */
    .card-media { position: relative; aspect-ratio: 16 / 9; overflow: hidden; flex-shrink: 0; }
    .card-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
    .post-card:hover .card-image { transform: scale(1.05); }
    .card-image.draft-image { filter: grayscale(20%); }
    .post-card:hover .card-image.draft-image { filter: grayscale(0%); }

    /* Status Badge on Image */
    .status-badge-overlay { position: absolute; top: 16px; left: 16px; z-index: 3; }
    .status-badge { backdrop-filter: blur(10px); color: white; padding: 8px 16px; border-radius: 12px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
    .status-badge.published-badge { background: rgba(16, 185, 129, 0.8); }
    .status-badge.draft-badge { background: rgba(55, 65, 81, 0.95); }
    .status-badge.private-badge { background: rgba(107, 114, 128, 0.9); }
    .status-badge i { font-size: 14px; }

    /* Category Badge */
    .card-category-badge { position: absolute; top: 16px; right: 16px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); padding: 6px 14px; border-radius: 10px; font-size: 12px; font-weight: 600; text-decoration: none; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid rgba(0,0,0,0.05); transition: background 0.3s ease; z-index: 3; }
    .card-category-badge:hover { background: white; }

    /* Hover Overlay */
    .card-media-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 60%); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; z-index: 2; }
    .post-card:hover .card-media-overlay { opacity: 1; }
    .overlay-link { color: white; font-size: 16px; font-weight: 600; text-decoration: none; padding: 12px 28px; border-radius: 50px; transform: translateY(10px); transition: transform 0.3s ease, background 0.3s ease; display: flex; align-items: center; gap: 8px; }
    .post-card:hover .overlay-link { transform: translateY(0); }
    .overlay-link.edit-draft-link { background: var(--warning); }
    .overlay-link.edit-draft-link:hover { background: #d97706; color: white; }
    .overlay-link.read-article-link { border: 2px solid white; }
    .overlay-link.read-article-link:hover { background: white; color: #1a202c; }

    /* Card Content */
    .card-content { padding: 24px; flex-grow: 1; display: flex; flex-direction: column; }
    .last-modified { display: inline-flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; color: #6b7280; background-color: #f3f4f6; padding: 6px 12px; border-radius: 8px; margin-bottom: 12px; align-self: flex-start; }
    .card-title-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 12px; }
    .card-title { font-size: 22px; font-weight: 700; line-height: 1.3; margin: 0; color: #1a202c; flex-grow: 1;}
    .card-title a { color: inherit; text-decoration: none; transition: color 0.3s ease; }
    .card-title a:hover { color: var(--primary); }
    .card-title a.draft-title:hover { color: var(--warning); }
    .card-excerpt { color: #4a5568; line-height: 1.6; margin-bottom: 20px; flex-grow: 1; }
    .no-excerpt { color: #9ca3af; font-style: italic; }

    /* Card Meta/Stats Bar */
    .card-meta-bar { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #e2e8f0; padding-top: 16px; margin-top: auto; }
    .author-info { display: flex; align-items: center; gap: 12px; text-decoration: none; }
    .author-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .author-avatar-initials { width: 40px; height: 40px; border-radius: 50%; background: var(--gradient-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; }
    .author-name-stack { display: flex; flex-direction: column; }
    .author-name { font-size: 14px; font-weight: 600; color: #4a5568; transition: color 0.3s ease;}
    .author-info:hover .author-name { color: var(--primary); }
    .post-date { font-size: 12px; color: #718096; }
    .card-stats { display: flex; align-items: center; gap: 12px; font-size: 13px; color: #718096; }
    .stat-item { display: flex; align-items: center; gap: 5px; }
    .stat-item i { font-size: 14px; }
    .stat-count { font-weight: 600; }

    /* Actions Menu */
    .card-actions-menu .dropdown-toggle::after { display: none; }
    .card-actions-btn { width: 36px; height: 36px; border-radius: 10px; background: #f3f4f6; border: none; display: flex; align-items: center; justify-content: center; color: #718096; font-size: 16px; transition: all 0.3s ease; flex-shrink: 0; }
    .card-actions-btn:hover { background: #e5e7eb; color: #1a202c; }
    .modern-dropdown { border: none; border-radius: 16px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); padding: 8px; margin-top: 8px !important; min-width: 200px; border: 1px solid rgba(0, 0, 0, 0.05); }
    .modern-dropdown .dropdown-item { padding: 10px 16px; border-radius: 10px; margin: 2px 0; transition: all 0.2s ease; color: #4a5568; font-weight: 500; display: flex; align-items: center; gap: 12px; }
    .modern-dropdown .dropdown-item:hover, .modern-dropdown .dropdown-item:focus { background: rgba(102, 126, 234, 0.1); color: var(--primary); outline: none; }
    .modern-dropdown .dropdown-item.delete:hover { background: rgba(239, 68, 68, 0.1); color: var(--error); }
    .modern-dropdown .dropdown-divider { margin: 8px 0; opacity: 0.1; }

    /* Empty State */
    .empty-state { text-align: center; padding: 5rem 2rem; background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .empty-state i { font-size: 4rem; color: #9ca3af; margin-bottom: 1.5rem; }
    .empty-state h3 { color: var(--text-heading); margin-bottom: 1rem; font-weight: 700; }
    .empty-state p { color: var(--text-light); margin-bottom: 2rem; max-width: 500px; margin-left: auto; margin-right: auto; }

    /* Pagination */
    .pagination { margin-top: 3rem; }
    .page-item .page-link { background: white; border: 2px solid var(--neutral-200); color: var(--text-heading); padding: 0.75rem 1rem; border-radius: 12px; font-weight: 600; text-decoration: none; margin: 0 4px; transition: all 0.3s ease; }
    .page-item .page-link:hover { background: var(--gradient-primary); color: white; border-color: transparent; }
    .page-item.active .page-link { background: var(--gradient-primary); color: white; border-color: transparent; }

    @media (max-width: 768px) { 
        .posts-grid { grid-template-columns: 1fr; } 
        .dashboard-title { font-size: 2rem; }
        .filter-search-bar .row { gap: 1rem; }
    }
</style>
{% endblock %}

{% block content %}
<section class="dashboard-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'blog:home' %}"><i class="bi bi-house-door me-1"></i>Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'blog:dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item active">My Posts</li>
                    </ol>
                </nav>
                <h1 class="dashboard-title"><i class="bi bi-collection-fill me-2"></i>My Posts</h1>
                <p class="dashboard-subtitle">Manage all your published, draft, and private posts in one place.</p>
            </div>
            <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
                <a href="{% url 'blog:post_write' %}" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus-circle"></i>
                    <span>Write New Post</span>
                </a>
            </div>
        </div>
    </div>
</section>

<section class="dashboard-content">
    <div class="container">
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="myPostsTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="published-tab" data-bs-toggle="tab" data-bs-target="#published" type="button" role="tab" aria-controls="published" aria-selected="true">
                    Published <span class="badge">{{ published_posts.paginator.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="drafts-tab" data-bs-toggle="tab" data-bs-target="#drafts" type="button" role="tab" aria-controls="drafts" aria-selected="false">
                    Drafts <span class="badge">{{ draft_posts.paginator.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="private-tab" data-bs-toggle="tab" data-bs-target="#private" type="button" role="tab" aria-controls="private" aria-selected="false">
                    Private <span class="badge">{{ private_posts.paginator.count }}</span>
                </button>
            </li>
        </ul>

        <!-- Filter/Search Bar -->
        <div class="filter-search-bar">
            <!-- This can be made dynamic with JS to change sorting options based on active tab -->
            <!-- For simplicity, this example uses a generic search bar -->
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" class="form-control" placeholder="Search all your posts..." id="searchInput">
            </div>
        </div>

        <div class="tab-content" id="myPostsTabContent">
            <!-- Published Posts Tab -->
            <div class="tab-pane fade show active" id="published" role="tabpanel" aria-labelledby="published-tab">
                {% if published_posts %}
                    <div class="posts-grid">
                        {% for post in published_posts %}
                            {% include 'partials/_post_card.html' with post=post status='published' %}
                        {% endfor %}
                    </div>
                    <!-- Pagination for Published -->
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-file-earmark-check"></i>
                        <h3>No Published Posts Yet</h3>
                        <p>You haven't published any posts yet. Start writing and share your stories with the world!</p>
                        <a href="{% url 'blog:post_write' %}" class="btn btn-primary btn-lg"><i class="bi bi-plus-circle me-2"></i>Write Your First Post</a>
                    </div>
                {% endif %}
            </div>

            <!-- Drafts Tab -->
            <div class="tab-pane fade" id="drafts" role="tabpanel" aria-labelledby="drafts-tab">
                {% if draft_posts %}
                    <div class="posts-grid">
                        {% for post in draft_posts %}
                            {% include 'partials/_post_card.html' with post=post status='draft' %}
                        {% endfor %}
                    </div>
                    <!-- Pagination for Drafts -->
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-file-earmark-plus"></i>
                        <h3>No Drafts Found</h3>
                        <p>You don't have any draft posts yet. Start writing a new post and save it as a draft to see it here.</p>
                        <a href="{% url 'blog:post_write' %}" class="btn btn-primary btn-lg"><i class="bi bi-plus-circle me-2"></i>Start Writing</a>
                    </div>
                {% endif %}
            </div>

            <!-- Private Posts Tab -->
            <div class="tab-pane fade" id="private" role="tabpanel" aria-labelledby="private-tab">
                {% if private_posts %}
                    <div class="posts-grid">
                        {% for post in private_posts %}
                            {% include 'partials/_post_card.html' with post=post status='private' %}
                        {% endfor %}
                    </div>
                    <!-- Pagination for Private -->
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-shield-lock"></i>
                        <h3>No Private Posts</h3>
                        <p>Private posts are only visible to you. It's a great way to keep personal notes or posts you're not ready to share.</p>
                        <a href="{% url 'blog:post_write' %}" class="btn btn-primary btn-lg"><i class="bi bi-plus-circle me-2"></i>Create a Private Post</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Live search functionality
const searchInput = document.getElementById('searchInput');
if (searchInput) {
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase().trim();
        document.querySelectorAll('.post-card').forEach(card => {
            const title = card.querySelector('.card-title a').textContent.toLowerCase();
            const excerpt = card.querySelector('.card-excerpt')?.textContent.toLowerCase() || '';
            const shouldShow = title.includes(query) || excerpt.includes(query);
            card.style.display = shouldShow ? 'flex' : 'none';
        });

        // Optional: Show empty message per tab if no results
        document.querySelectorAll('.tab-pane').forEach(tabPane => {
            const visibleCards = tabPane.querySelectorAll('.post-card[style*="display: flex"], .post-card:not([style*="display: none"])').length;
            let emptyMessage = tabPane.querySelector('.search-empty-message');

            if (visibleCards === 0 && query.length > 0) {
                if (!emptyMessage) {
                    emptyMessage = document.createElement('div');
                    emptyMessage.className = 'empty-state search-empty-message';
                    emptyMessage.style.gridColumn = '1 / -1';
                    emptyMessage.innerHTML = `
                        <i class="bi bi-search"></i>
                        <h3>No posts found</h3>
                        <p>No posts match your search for "<strong>${query}</strong>" in this tab.</p>`;
                    tabPane.querySelector('.posts-grid')?.appendChild(emptyMessage);
                }
            } else if (emptyMessage) {
                emptyMessage.remove();
            }
        });
    });
}

// Persist active tab in URL for better UX on page reload/sharing
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    if (hash) {
        const triggerEl = document.querySelector('.nav-tabs button[data-bs-target="' + hash + '"]');
        if (triggerEl) {
            new bootstrap.Tab(triggerEl).show();
        }
    }

    const tabButtons = document.querySelectorAll('button[data-bs-toggle="tab"]');
    tabButtons.forEach(tabButton => {
        tabButton.addEventListener('shown.bs.tab', function (event) {
            history.pushState(null, null, event.target.dataset.bsTarget);
        });
    });
});

// Generic confirm delete function
function confirmDelete(event, title, postId) {
    event.preventDefault();
    if (confirm(`Are you sure you want to delete "${title}"? This action cannot be undone.`)) {
        // Here you would typically submit a form or make an AJAX call to the delete URL
        console.log('Deleting post:', postId);
        // e.g., document.getElementById('delete-form-' + postId).submit();
        showNotification('Post deleted successfully', 'success');
    }
}

// Generic notification function
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        z-index: 9999;
        animation: slideInRight 0.3s ease;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Add animation keyframes dynamically
const styleSheet = document.createElement("style");
styleSheet.type = "text/css";
styleSheet.innerText = `
    @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes slideOutRight { from { transform: translateX(0); } to { transform: translateX(100%); } }
`;
document.head.appendChild(styleSheet);
</script>
{% endblock %}
